/* translate ctlwav in ~/sc/src/all.lsp to C
 *   written Wed 20-Oct-21 at 9:51 by CLM of 8-May-18
 */

#include <mus-config.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdarg.h>
#include <math.h>
#include <signal.h>
#include <cmus.h>

static sig_atomic_t got_sigint = 0; /* catch C-C if hung */
static void sig_err(int sig) {got_sigint = sig;}

int clm_ctlwav (double *clm_double, int datar_len, int *clm_int, int datai_len)
{
  /* The _clm_* variables are temporary values generated by the run macro */
  void (*old_SIGINT)(int);
  mus_long_t I;
  double _clm_37, _clm_30, _clm_24, _clm_22, _clm_20, _clm_18, _clm_16, _clm_14, _clm_8, _clm_7, _clm_6, _clm_5;
  mus_any *_OUTPUT_ = NULL, *WAV = NULL, *AMPF = NULL, *FENV = NULL;
  void *all_gens = NULL;
  mus_long_t clm_beg, clm_end;
  
  all_gens = clm_make_genbag();
  clm_beg = clm_to_mus_long_t(clm_int, 1);
  clm_end = clm_to_mus_long_t(clm_int, 3);
  I = clm_int[47];
  if (CLM_ENV_P(7))
    FENV = clm_add_gen_to_genbag(all_gens, 
      mus_make_env(
        (double *)(clm_double + CLM_RLOC(7) + 3), /* breakpoints */
        clm_int[CLM_ILOC(7) + 2], /* num points */
        clm_double[CLM_RLOC(7) + 1], /* scaler */
        clm_double[CLM_RLOC(7) + 2], /* offset */
        clm_double[CLM_RLOC(7)], /* base */
        0.0, /* dur useless here */
        clm_int[CLM_ILOC(7) + 3], /* end */
        NULL)); /* original data -- handled internally */
  #define FM 9
  #define FM_r 2
  if (CLM_ENV_P(11))
    AMPF = clm_add_gen_to_genbag(all_gens, 
      mus_make_env(
        (double *)(clm_double + CLM_RLOC(11) + 3), /* breakpoints */
        clm_int[CLM_ILOC(11) + 2], /* num points */
        clm_double[CLM_RLOC(11) + 1], /* scaler */
        clm_double[CLM_RLOC(11) + 2], /* offset */
        clm_double[CLM_RLOC(11)], /* base */
        0.0, /* dur useless here */
        clm_int[CLM_ILOC(11) + 3], /* end */
        NULL)); /* original data -- handled internally */
  #define _clm_12 13
  #define _clm_12_r 4
  #define TYPE 15
  #define TYPE_r 5
  if (CLM_OSCIL_P(17))
    WAV = clm_add_gen_to_genbag(all_gens, 
      mus_make_oscil(
        mus_radians_to_hz(clm_double[CLM_RLOC(17)]),
        clm_double[CLM_RLOC(17) + 1]));
  if (CLM_SAWTOOTH_WAVE_P(17))
    WAV = clm_add_gen_to_genbag(all_gens, 
      mus_make_sawtooth_wave(
        mus_radians_to_hz(clm_double[CLM_RLOC(17)]),
        clm_double[CLM_RLOC(17) + 2],
        clm_double[CLM_RLOC(17) + 1]));
  if (CLM_TRIANGLE_WAVE_P(17))
    WAV = clm_add_gen_to_genbag(all_gens, 
      mus_make_triangle_wave(
        mus_radians_to_hz(clm_double[CLM_RLOC(17)]),
        clm_double[CLM_RLOC(17) + 2],
        clm_double[CLM_RLOC(17) + 1]));
  if (CLM_SQUARE_WAVE_P(17))
    WAV = clm_add_gen_to_genbag(all_gens, 
      mus_make_square_wave(
        mus_radians_to_hz(clm_double[CLM_RLOC(17)]),
        clm_double[CLM_RLOC(17) + 2],
        clm_double[CLM_RLOC(17) + 1]));
  if (CLM_PULSE_TRAIN_P(17))
    WAV = clm_add_gen_to_genbag(all_gens, 
      mus_make_pulse_train(
        mus_radians_to_hz(clm_double[CLM_RLOC(17)]),
        clm_double[CLM_RLOC(17) + 2],
        clm_double[CLM_RLOC(17) + 1]));
  #define SAMP 19
  #define SAMP_r 7
  #define RSAMP 21
  #define RSAMP_r 8
  #define RESCALE 23
  #define RESCALE_r 9
  #define _clm_31 25
  #define _clm_31_r 10
  #define WAV_MIN 27
  #define WAV_MIN_r 11
  #define WAV_RANGE 29
  #define WAV_RANGE_r 12
  #define PROP 31
  #define PROP_r 13
  #define _clm_32 33
  #define _clm_32_r 14
  #define OUT_MIN 35
  #define OUT_MIN_r 15
  #define _clm_33 37
  #define _clm_33_r 16
  #define OUT_RANGE 39
  #define OUT_RANGE_r 17
  #define SAMPLES 41
  #define SAMPLES_r 18
  #define INDX 43
  #define INDX_r 19
  _OUTPUT_ = clm_output();
  if (clm_beg > clm_end) return(1);
  got_sigint = 0; old_SIGINT = clm_signal(SIGINT, sig_err);                     /* trap SIGINT */
  I = clm_beg;                                                                  /* pass counter */

SAMPLE_LOOP_BEGIN:
  if (got_sigint != 0) {clm_int[0] = (int)got_sigint; goto RUN_ALL_DONE;}
  if (I > clm_end) {I = clm_end; goto RUN_ALL_DONE;}
                                                                                /* (progn */
  _clm_6 = mus_env(FENV);                                                       /* (env FENV) */
  _clm_5 = mus_hz_to_radians(_clm_6);
  clm_int[FM + 0] = 2;
  clm_double[FM_r+0] = _clm_5;                                                  /* (setf FM _clm_5) */
  _clm_8 = mus_env(AMPF);                                                       /* (env AMPF) */
                                                                                /* (case type */
  goto L_10;
L_13:
  _clm_14 = mus_oscil_fm(WAV, ((clm_int[FM] == 2) ? clm_double[FM_r] : (double)(clm_int[FM + 1]))); /* (oscil WAV FM) */
  clm_int[_clm_12 + 0] = 2;
  clm_double[_clm_12_r+0] = _clm_14;                                            /* (setf _clm_12 _clm_14) */
  goto L_11;
L_15:
  _clm_16 = mus_oscil_fm(WAV, ((clm_int[FM] == 2) ? clm_double[FM_r] : (double)(clm_int[FM + 1]))); /* (oscil WAV FM) */
  clm_int[_clm_12 + 0] = 2;
  clm_double[_clm_12_r+0] = _clm_16;                                            /* (setf _clm_12 _clm_16) */
  goto L_11;
L_17:
  _clm_18 = mus_sawtooth_wave(WAV, ((clm_int[FM] == 2) ? clm_double[FM_r] : (double)(clm_int[FM + 1]))); /* (sawtooth-wave WAVFM) */
  clm_int[_clm_12 + 0] = 2;
  clm_double[_clm_12_r+0] = _clm_18;                                            /* (setf _clm_12 _clm_18) */
  goto L_11;
L_19:
  _clm_20 = mus_triangle_wave(WAV, ((clm_int[FM] == 2) ? clm_double[FM_r] : (double)(clm_int[FM + 1]))); /* (triangle-wave WAVFM) */
  clm_int[_clm_12 + 0] = 2;
  clm_double[_clm_12_r+0] = _clm_20;                                            /* (setf _clm_12 _clm_20) */
  goto L_11;
L_21:
  _clm_22 = mus_square_wave(WAV, ((clm_int[FM] == 2) ? clm_double[FM_r] : (double)(clm_int[FM + 1]))); /* (square-wave WAVFM) */
  clm_int[_clm_12 + 0] = 2;
  clm_double[_clm_12_r+0] = _clm_22;                                            /* (setf _clm_12 _clm_22) */
  goto L_11;
L_23:
  _clm_24 = mus_pulse_train(WAV, ((clm_int[FM] == 2) ? clm_double[FM_r] : (double)(clm_int[FM + 1]))); /* (pulse-train WAVFM) */
  clm_int[_clm_12 + 0] = 2;
  clm_double[_clm_12_r+0] = _clm_24;                                            /* (setf _clm_12 _clm_24) */
  goto L_11;
L_10:
  switch ((int)((clm_int[TYPE] == 2) ? clm_double[TYPE_r] : (double)(clm_int[TYPE + 1]))){
    case 1: goto L_13; break;
    case 2: goto L_15; break;
    case 3: goto L_17; break;
    case 4: goto L_19; break;
    case 5: goto L_21; break;
    case 6: goto L_23; break;
    }
  clm_int[_clm_12 + 0] = 0;
  clm_int[_clm_12 + 0 + 1] = 0;                                                 /* (setf _clm_12 NIL) */
L_11:
                                                                                /* (* _clm_8 _clm_12) */
  _clm_7 = ((_clm_8) * (((clm_int[_clm_12] == 2) ? clm_double[_clm_12_r] : (double)(clm_int[_clm_12 + 1]))));
  clm_int[SAMP + 0] = 2;
  clm_double[SAMP_r+0] = _clm_7;                                                /* (setf SAMP _clm_7) */
  clm_int[RSAMP + 0] = clm_int[SAMP + 0];
  clm_int[RSAMP + 0 + 1] = clm_int[SAMP + 0 + 1];
  clm_double[RSAMP_r + 0] = clm_double[SAMP_r + 0];                             /* (setf RSAMP SAMP) */
                                                                                /* (if rescale */
  if (((clm_int[RESCALE] == 0) && (clm_int[RESCALE + 1] == 0))) goto L_27;
                                                                                /* (- samp wav-min) */
  if ((clm_int[SAMP + 0] == 1) && (clm_int[WAV_MIN + 0] == 1))
    {clm_int[_clm_31 + 0] = 1;
  clm_int[_clm_31 + 0 + 1] = ((clm_int[SAMP + 0 + 1]) - (clm_int[WAV_MIN + 0 + 1]));}
  else {clm_int[_clm_31 + 0] = 2;
  clm_double[_clm_31_r+0] = ((((clm_int[SAMP] == 2) ? clm_double[SAMP_r] : (double)(clm_int[SAMP + 1]))) - (((clm_int[WAV_MIN] == 2) ? clm_double[WAV_MIN_r] : (double)(clm_int[WAV_MIN + 1]))));}
  _clm_30 = ((double)((clm_int[_clm_31] == 2) ? clm_double[_clm_31_r] : (double)(clm_int[_clm_31 + 1])) / (double)((((clm_int[WAV_RANGE] == 2) ? clm_double[WAV_RANGE_r] : (double)(clm_int[WAV_RANGE + 1])))));
                                                                                /* (/ _clm_31 wav-range) */
  clm_int[PROP + 0] = 2;
  clm_double[PROP_r+0] = _clm_30;                                               /* (setf PROP _clm_30) */
                                                                                /* (* prop out-range) */
  if ((clm_int[PROP + 0] == 1) && (clm_int[OUT_RANGE + 0] == 1))
    {clm_int[_clm_33 + 0] = 1;
  clm_int[_clm_33 + 0 + 1] = ((clm_int[PROP + 0 + 1]) * (clm_int[OUT_RANGE + 0 + 1]));}
  else {clm_int[_clm_33 + 0] = 2;
  clm_double[_clm_33_r+0] = ((((clm_int[PROP] == 2) ? clm_double[PROP_r] : (double)(clm_int[PROP + 1]))) * (((clm_int[OUT_RANGE] == 2) ? clm_double[OUT_RANGE_r] : (double)(clm_int[OUT_RANGE + 1]))));}
                                                                                /* (+ out-min _clm_33) */
  if ((clm_int[OUT_MIN + 0] == 1) && (clm_int[_clm_33 + 0] == 1))
    {clm_int[_clm_32 + 0] = 1;
  clm_int[_clm_32 + 0 + 1] = ((clm_int[OUT_MIN + 0 + 1]) + (clm_int[_clm_33 + 0 + 1]));}
  else {clm_int[_clm_32 + 0] = 2;
  clm_double[_clm_32_r+0] = ((((clm_int[OUT_MIN] == 2) ? clm_double[OUT_MIN_r] : (double)(clm_int[OUT_MIN + 1]))) + (((clm_int[_clm_33] == 2) ? clm_double[_clm_33_r] : (double)(clm_int[_clm_33 + 1]))));}
  clm_int[RSAMP + 0] = clm_int[_clm_32 + 0];
  clm_int[RSAMP + 0 + 1] = clm_int[_clm_32 + 0 + 1];
  clm_double[RSAMP_r + 0] = clm_double[_clm_32_r + 0];                          /* (setf RSAMP _clm_32) */
  goto L_28;
L_27:
L_28:
  {int lci; lci = clm_int[INDX + 0 + 1];
  switch (CLM_ARR_TYPE(clm_int[SAMPLES + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[SAMPLES + 0 + 1]) + lci] = ((clm_int[RSAMP] == 2) ? clm_double[RSAMP_r] : (double)(clm_int[RSAMP + 1])); break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[SAMPLES + 0 + 1]) + lci] = ((clm_int[RSAMP] == 2) ? clm_double[RSAMP_r] : (double)(clm_int[RSAMP + 1])); break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[SAMPLES + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[SAMPLES + 0 + 1]) + lci;
      clm_int[iblock] = clm_int[RSAMP + 0];
      clm_int[iblock + 1] = clm_int[RSAMP + 0 + 1];
      clm_double[rblock] = clm_double[RSAMP_r+0];
  }}}

  clm_int[INDX + 0] = 1;
  clm_int[INDX + 0 + 1] += 1;                                                   /* (incf INDX 1) */
  _clm_37 = mus_out_any(I, ((clm_int[SAMP] == 2) ? clm_double[SAMP_r] : (double)(clm_int[SAMP + 1])), 0, _OUTPUT_);
  I++;                                                                          /* increment pass counter and loop */
goto SAMPLE_LOOP_BEGIN;

RUN_ALL_DONE:
  clm_signal(SIGINT,old_SIGINT);
  clm_int[47] = I;
  if (mus_is_oscil(WAV))
    {
     clm_double[clm_int[clm_int[17 + 1] + 1] + 0] = mus_hz_to_radians(mus_frequency(WAV));
     clm_double[clm_int[clm_int[17 + 1] + 1] + 1] = mus_phase(WAV);
    }
  if (mus_is_sawtooth_wave(WAV))
    {
     clm_double[clm_int[clm_int[17 + 1] + 1] + 0] = mus_hz_to_radians(mus_frequency(WAV));
     clm_double[clm_int[clm_int[17 + 1] + 1] + 1] = mus_phase(WAV);
     clm_double[clm_int[clm_int[17 + 1] + 1] + 2] = mus_scaler(WAV);
    }
  if (mus_is_triangle_wave(WAV))
    {
     clm_double[clm_int[clm_int[17 + 1] + 1] + 0] = mus_hz_to_radians(mus_frequency(WAV));
     clm_double[clm_int[clm_int[17 + 1] + 1] + 1] = mus_phase(WAV);
     clm_double[clm_int[clm_int[17 + 1] + 1] + 2] = mus_scaler(WAV);
    }
  if (mus_is_square_wave(WAV))
    {
     clm_double[clm_int[clm_int[17 + 1] + 1] + 0] = mus_hz_to_radians(mus_frequency(WAV));
     clm_double[clm_int[clm_int[17 + 1] + 1] + 1] = mus_phase(WAV);
     clm_double[clm_int[clm_int[17 + 1] + 1] + 2] = mus_scaler(WAV);
    }
  if (mus_is_pulse_train(WAV))
    {
     clm_double[clm_int[clm_int[17 + 1] + 1] + 0] = mus_hz_to_radians(mus_frequency(WAV));
     clm_double[clm_int[clm_int[17 + 1] + 1] + 1] = mus_phase(WAV);
     clm_double[clm_int[clm_int[17 + 1] + 1] + 2] = mus_scaler(WAV);
    }
  if (all_gens) clm_free_genbag(all_gens);

  return(1);
}

