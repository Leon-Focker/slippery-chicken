/* translate spec-an in ~/sc/src/all.lsp to C
 *   written Wed 20-Oct-21 at 9:51 by CLM of 8-May-18
 */

#include <mus-config.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdarg.h>
#include <math.h>
#include <signal.h>
#include <cmus.h>

static sig_atomic_t got_sigint = 0; /* catch C-C if hung */
static void sig_err(int sig) {got_sigint = sig;}

int clm_spec_an (double *clm_double, int datar_len, int *clm_int, int datai_len)
{
  /* The _clm_* variables are temporary values generated by the run macro */
  void (*old_SIGINT)(int);
  mus_long_t LOOP_LIMIT_84, _clm_42, PEAKS, MAX_PEAKS, _clm_31, HIGHEST_BIN, _clm_15, FFTSIZE, K, _clm_5;
  bool _clm_114, _clm_100, _clm_94, _clm_80, _clm_61, _clm_60, _clm_59, _clm_56, _clm_53, _clm_43, _clm_32, _clm_16, _clm_6;
  double _clm_108, J, FREQ, _clm_76, _clm_75, AMP, _clm_74, _clm_73, _clm_72, _clm_71, OFFSET, _clm_70, _clm_69, _clm_68, _clm_67, _clm_66, LOGRA, _clm_65, LOGCA, _clm_64, LOGLA, _clm_63, CA, LA, _clm_23, _clm_22, _clm_9;
  mus_any *RD = NULL;
  void *all_gens = NULL;
  mus_long_t clm_beg, clm_end;
  
  all_gens = clm_make_genbag();
  clm_beg = clm_to_mus_long_t(clm_int, 1);
  clm_end = clm_to_mus_long_t(clm_int, 3);
  FFTSIZE = clm_int[59];
  if (CLM_READIN_P(5))
    RD = clm_add_gen_to_genbag(all_gens, 
      mus_make_readin_with_buffer_size(
        (char *)(clm_int + CLM_ILOC(5) + 6 + 2), /* filename */
        clm_int[CLM_ILOC(5) + 4], /* chan */
        clm_to_mus_long_t(clm_int, CLM_ILOC(5) + 1), /* start */
        clm_int[CLM_ILOC(5) + 3], /* direction */
        clm_int[CLM_ILOC(5) + 5]));
  #define FDR 7
  #define FDR_r 1
  #define FDI 9
  #define FDI_r 2
  HIGHEST_BIN = clm_int[61];
  #define _clm_19 11
  #define _clm_19_r 3
  #define X 13
  #define X_r 4
  #define _clm_20 15
  #define _clm_20_r 5
  #define Y 17
  #define Y_r 6
  #define _clm_24 19
  #define _clm_24_r 7
  #define _clm_25 21
  #define _clm_25_r 8
  #define _clm_26 23
  #define _clm_26_r 9
  #define FFTAMPS 25
  #define FFTAMPS_r 10
  MAX_PEAKS = clm_int[63];
  #define PEAK_AMPS 27
  #define PEAK_AMPS_r 11
  #define _clm_36 29
  #define _clm_36_r 12
  #define RA 31
  #define RA_r 13
  PEAKS = clm_int[65];
  #define _clm_48 33
  #define _clm_48_r 14
  #define LOWEST_MAGNITUDE 35
  #define LOWEST_MAGNITUDE_r 15
  #define FFT_MAG 37
  #define FFT_MAG_r 16
  #define MINP 39
  #define MINP_r 17
  #define _clm_82 41
  #define _clm_82_r 18
  #define MINPEAK 43
  #define MINPEAK_r 19
  J = clm_double[27];
  LOOP_LIMIT_84 = clm_int[67];
  #define _clm_101 45
  #define _clm_101_r 20
  #define _clm_105 47
  #define _clm_105_r 21
  #define PEAK_FREQS 49
  #define PEAK_FREQS_r 22
  #define _SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ 51
  #define _SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS__r 23
  #define _SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS_ 53
  #define _SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS__r 24
  #define PRINTING 55
  #define PRINTING_r 25
  #define _clm_128 57
  #define _clm_128_r 26
  got_sigint = 0; old_SIGINT = clm_signal(SIGINT, sig_err);                     /* trap SIGINT */

SAMPLE_LOOP_BEGIN:
  if (got_sigint != 0) {clm_int[0] = (int)got_sigint; goto RUN_ALL_DONE;}
                                                                                /* (progn */
                                                                                /* (dotimes (k fftsize) */
  K = 0;                                                                        /* (setf K 0) */
  _clm_5 = FFTSIZE;                                                             /* (setf _clm_5 FFTSIZE) */
L_2:
  _clm_6 = (_clm_5 > K);                                                        /* (> _clm_5 K) */
  if (_clm_6) goto L_3;
  goto L_4;
L_3:
  _clm_9 = mus_readin(RD);
  {int lci; lci = K;
  switch (CLM_ARR_TYPE(clm_int[FDR + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[FDR + 0 + 1]) + lci] = _clm_9; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[FDR + 0 + 1]) + lci] = _clm_9; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[FDR + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[FDR + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = _clm_9;
  }}}

  K += 1;                                                                       /* (incf K 1) */
  goto L_2;
L_4:
  mus_fft((double *)(clm_double + CLM_ARR_RBLOCK(clm_int[FDR + 0 + 1])), (double *)(clm_double + CLM_ARR_RBLOCK(clm_int[FDI + 0 + 1])), FFTSIZE, 1); /* (dotimes (k highest-bin) */
  K = 0;                                                                        /* (setf K 0) */
  _clm_15 = HIGHEST_BIN;                                                        /* (setf _clm_15 HIGHEST-BIN) */
L_12:
  _clm_16 = (_clm_15 > K);                                                      /* (> _clm_15 K) */
  if (_clm_16) goto L_13;
  goto L_14;
L_13:
  {int lci; lci = K;
  switch (CLM_ARR_TYPE(clm_int[FDR + 0 + 1]))
    {
    case 36: clm_int[_clm_19 + 0] = 2;
  clm_double[_clm_19_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[FDR + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_19 + 0] = 1;
  clm_int[_clm_19 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[FDR + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[FDR + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[FDR + 0 + 1]) + lci;
      clm_int[_clm_19 + 0] = clm_int[iblock];
      clm_int[_clm_19 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_19_r + 0] = clm_double[rblock];
  }}}

  clm_int[X + 0] = clm_int[_clm_19 + 0];
  clm_int[X + 0 + 1] = clm_int[_clm_19 + 0 + 1];
  clm_double[X_r + 0] = clm_double[_clm_19_r + 0];                              /* (setf X _clm_19) */
  {int lci; lci = K;
  switch (CLM_ARR_TYPE(clm_int[FDI + 0 + 1]))
    {
    case 36: clm_int[_clm_20 + 0] = 2;
  clm_double[_clm_20_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[FDI + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_20 + 0] = 1;
  clm_int[_clm_20 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[FDI + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[FDI + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[FDI + 0 + 1]) + lci;
      clm_int[_clm_20 + 0] = clm_int[iblock];
      clm_int[_clm_20 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_20_r + 0] = clm_double[rblock];
  }}}

  clm_int[Y + 0] = clm_int[_clm_20 + 0];
  clm_int[Y + 0 + 1] = clm_int[_clm_20 + 0 + 1];
  clm_double[Y_r + 0] = clm_double[_clm_20_r + 0];                              /* (setf Y _clm_20) */
                                                                                /* (* x x) */
  if ((clm_int[X + 0] == 1) && (clm_int[X + 0] == 1))
    {clm_int[_clm_25 + 0] = 1;
  clm_int[_clm_25 + 0 + 1] = ((clm_int[X + 0 + 1]) * (clm_int[X + 0 + 1]));}
  else {clm_int[_clm_25 + 0] = 2;
  clm_double[_clm_25_r+0] = ((((clm_int[X] == 2) ? clm_double[X_r] : (double)(clm_int[X + 1]))) * (((clm_int[X] == 2) ? clm_double[X_r] : (double)(clm_int[X + 1]))));}
                                                                                /* (* y y) */
  if ((clm_int[Y + 0] == 1) && (clm_int[Y + 0] == 1))
    {clm_int[_clm_26 + 0] = 1;
  clm_int[_clm_26 + 0 + 1] = ((clm_int[Y + 0 + 1]) * (clm_int[Y + 0 + 1]));}
  else {clm_int[_clm_26 + 0] = 2;
  clm_double[_clm_26_r+0] = ((((clm_int[Y] == 2) ? clm_double[Y_r] : (double)(clm_int[Y + 1]))) * (((clm_int[Y] == 2) ? clm_double[Y_r] : (double)(clm_int[Y + 1]))));}
                                                                                /* (+ _clm_25 _clm_26) */
  if ((clm_int[_clm_25 + 0] == 1) && (clm_int[_clm_26 + 0] == 1))
    {clm_int[_clm_24 + 0] = 1;
  clm_int[_clm_24 + 0 + 1] = ((clm_int[_clm_25 + 0 + 1]) + (clm_int[_clm_26 + 0 + 1]));}
  else {clm_int[_clm_24 + 0] = 2;
  clm_double[_clm_24_r+0] = ((((clm_int[_clm_25] == 2) ? clm_double[_clm_25_r] : (double)(clm_int[_clm_25 + 1]))) + (((clm_int[_clm_26] == 2) ? clm_double[_clm_26_r] : (double)(clm_int[_clm_26 + 1]))));}
  _clm_23 = sqrt((double)(((clm_int[_clm_24] == 2) ? clm_double[_clm_24_r] : (double)(clm_int[_clm_24 + 1])))); /* (sqrt _clm_24) */
                                                                                /* (* 2 _clm_23) */
  _clm_22 = ((2) * (_clm_23));
  {int lci; lci = K;
  switch (CLM_ARR_TYPE(clm_int[FFTAMPS + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci] = _clm_22; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci] = _clm_22; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[FFTAMPS + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = _clm_22;
  }}}

  K += 1;                                                                       /* (incf K 1) */
  goto L_12;
L_14:
                                                                                /* (dotimes (k max-peaks) */
  K = 0;                                                                        /* (setf K 0) */
  _clm_31 = MAX_PEAKS;                                                          /* (setf _clm_31 MAX-PEAKS) */
L_28:
  _clm_32 = (_clm_31 > K);                                                      /* (> _clm_31 K) */
  if (_clm_32) goto L_29;
  goto L_30;
L_29:
  {int lci; lci = K;
  switch (CLM_ARR_TYPE(clm_int[PEAK_AMPS + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci] = 0.0; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci] = 0.0; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci;
    clm_int[iblock] = 2; clm_double[rblock] = 0.0;
  }}}

  K += 1;                                                                       /* (incf K 1) */
  goto L_28;
L_30:
  {int lci; lci = 0;
  switch (CLM_ARR_TYPE(clm_int[FFTAMPS + 0 + 1]))
    {
    case 36: clm_int[_clm_36 + 0] = 2;
  clm_double[_clm_36_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_36 + 0] = 1;
  clm_int[_clm_36 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[FFTAMPS + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci;
      clm_int[_clm_36 + 0] = clm_int[iblock];
      clm_int[_clm_36 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_36_r + 0] = clm_double[rblock];
  }}}

  clm_int[RA + 0] = clm_int[_clm_36 + 0];
  clm_int[RA + 0 + 1] = clm_int[_clm_36 + 0 + 1];
  clm_double[RA_r + 0] = clm_double[_clm_36_r + 0];                             /* (setf RA _clm_36) */
  LA = 0.0;                                                                     /* (setf LA 0.0) */
  CA = 0.0;                                                                     /* (setf CA 0.0) */
  PEAKS = 0;                                                                    /* (setf PEAKS 0) */
                                                                                /* (dotimes (k highest-bin) */
  K = 0;                                                                        /* (setf K 0) */
  _clm_42 = HIGHEST_BIN;                                                        /* (setf _clm_42 HIGHEST-BIN) */
L_39:
  _clm_43 = (_clm_42 > K);                                                      /* (> _clm_42 K) */
  if (_clm_43) goto L_40;
  goto L_41;
L_40:
  LA = CA;                                                                      /* (setf LA CA) */
  CA = ((clm_int[RA] == 2) ? clm_double[RA_r] : (double)(clm_int[RA + 1]));     /* (setf CA RA) */
  {int lci; lci = K;
  switch (CLM_ARR_TYPE(clm_int[FFTAMPS + 0 + 1]))
    {
    case 36: clm_int[_clm_48 + 0] = 2;
  clm_double[_clm_48_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_48 + 0] = 1;
  clm_int[_clm_48 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[FFTAMPS + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[FFTAMPS + 0 + 1]) + lci;
      clm_int[_clm_48 + 0] = clm_int[iblock];
      clm_int[_clm_48 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_48_r + 0] = clm_double[rblock];
  }}}

  clm_int[RA + 0] = clm_int[_clm_48 + 0];
  clm_int[RA + 0 + 1] = clm_int[_clm_48 + 0 + 1];
  clm_double[RA_r + 0] = clm_double[_clm_48_r + 0];                             /* (setf RA _clm_48) */
                                                                                /* (if (and (> ca lowest-magnitude) (> ca ra) (> ca la)) */
                                                                                /* (if (if (> ca lowest-magnitude)
     (> ca ra)) */
                                                                                /* (if (> ca lowest-magnitude) */
  _clm_59 = (CA > ((clm_int[LOWEST_MAGNITUDE] == 2) ? clm_double[LOWEST_MAGNITUDE_r] : (double)(clm_int[LOWEST_MAGNITUDE + 1]))); /* (> CA LOWEST-MAGNITUDE) */
  if ((!_clm_59)) goto L_57;
  _clm_60 = (CA > ((clm_int[RA] == 2) ? clm_double[RA_r] : (double)(clm_int[RA + 1]))); /* (> CA RA) */
  _clm_56 = _clm_60;                                                            /* (setf _clm_56 _clm_60) */
  goto L_58;
L_57:
  _clm_56 = 0;                                                                  /* (setf _clm_56 NIL) */
L_58:
  if ((!_clm_56)) goto L_54;
  _clm_61 = (CA > LA);                                                          /* (> CA LA) */
  _clm_53 = _clm_61;                                                            /* (setf _clm_53 _clm_61) */
  goto L_55;
L_54:
  _clm_53 = 0;                                                                  /* (setf _clm_53 NIL) */
L_55:
  if ((!_clm_53)) goto L_50;
  _clm_63 = log((double)(LA)) / 2.3025851;                                      /* (log LA 10) */
  LOGLA = _clm_63;                                                              /* (setf LOGLA _clm_63) */
  _clm_64 = log((double)(CA)) / 2.3025851;                                      /* (log CA 10) */
  LOGCA = _clm_64;                                                              /* (setf LOGCA _clm_64) */
  _clm_65 = log((double)(((clm_int[RA] == 2) ? clm_double[RA_r] : (double)(clm_int[RA + 1])))) / 2.3025851; /* (log RA 10) */
  LOGRA = _clm_65;                                                              /* (setf LOGRA _clm_65) */
                                                                                /* (- logla logra) */
  _clm_68 = ((LOGLA) - (LOGRA));
                                                                                /* (* 0.5 _clm_68) */
  _clm_67 = ((0.5) * (_clm_68));
                                                                                /* (* -2 logca) */
  _clm_70 = ((-2) * (LOGCA));
                                                                                /* (+ logla _clm_70 logra) */
  _clm_69 = ((LOGLA) + (_clm_70) + (LOGRA));
  _clm_66 = ((double)_clm_67 / (double)((_clm_69)));
                                                                                /* (/ _clm_67 _clm_69) */
  OFFSET = _clm_66;                                                             /* (setf OFFSET _clm_66) */
                                                                                /* (- logla logra) */
  _clm_74 = ((LOGLA) - (LOGRA));
                                                                                /* (* 0.25 _clm_74 offset) */
  _clm_73 = ((0.25) * (_clm_74) * (OFFSET));
                                                                                /* (- logca _clm_73) */
  _clm_72 = ((LOGCA) - (_clm_73));
  _clm_71 = pow((double)(10.0), (double)(_clm_72));                             /* (expt 10.0 _clm_72) */
  AMP = _clm_71;                                                                /* (setf AMP _clm_71) */
                                                                                /* (+ k offset -1) */
  _clm_76 = ((K) + (OFFSET) + (-1));
                                                                                /* (* fft-mag _clm_76) */
  _clm_75 = ((((clm_int[FFT_MAG] == 2) ? clm_double[FFT_MAG_r] : (double)(clm_int[FFT_MAG + 1]))) * (_clm_76));
  FREQ = _clm_75;                                                               /* (setf FREQ _clm_75) */
                                                                                /* (if (= peaks max-peaks) */
  _clm_80 = (PEAKS == MAX_PEAKS);                                               /* (== PEAKS MAX-PEAKS) */
  if ((!_clm_80)) goto L_78;
  clm_int[MINP + 0] = 1;
  clm_int[MINP + 0 + 1] = 0;                                                    /* (setf MINP 0) */
  {int lci; lci = 0;
  switch (CLM_ARR_TYPE(clm_int[PEAK_AMPS + 0 + 1]))
    {
    case 36: clm_int[_clm_82 + 0] = 2;
  clm_double[_clm_82_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_82 + 0] = 1;
  clm_int[_clm_82 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci;
      clm_int[_clm_82 + 0] = clm_int[iblock];
      clm_int[_clm_82 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_82_r + 0] = clm_double[rblock];
  }}}

  clm_int[MINPEAK + 0] = clm_int[_clm_82 + 0];
  clm_int[MINPEAK + 0 + 1] = clm_int[_clm_82 + 0 + 1];
  clm_double[MINPEAK_r + 0] = clm_double[_clm_82_r + 0];                        /* (setf MINPEAK _clm_82) */
  J = 1;                                                                        /* (setf J 1) */
  LOOP_LIMIT_84 = MAX_PEAKS;                                                    /* (setf LOOP-LIMIT-84 MAX-PEAKS) */
                                                                                /* (tagbody */
NEXT_LOOP_L_95:
                                                                                /* (if (>= j loop-limit-84) */
  _clm_94 = (J >= LOOP_LIMIT_84);                                               /* (>= J LOOP-LIMIT-84) */
  if ((!_clm_94)) goto L_92;
                                                                                /* (go end-loop */
  goto END_LOOP_L_95;
  goto L_93;
L_92:
L_93:
                                                                                /* (if (< (aref peak-amps j) minpeak) */
  {int lci; lci = J;
  switch (CLM_ARR_TYPE(clm_int[PEAK_AMPS + 0 + 1]))
    {
    case 36: clm_int[_clm_101 + 0] = 2;
  clm_double[_clm_101_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_101 + 0] = 1;
  clm_int[_clm_101 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci;
      clm_int[_clm_101 + 0] = clm_int[iblock];
      clm_int[_clm_101 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_101_r + 0] = clm_double[rblock];
  }}}

  _clm_100 = (((clm_int[_clm_101] == 2) ? clm_double[_clm_101_r] : (double)(clm_int[_clm_101 + 1])) < ((clm_int[MINPEAK] == 2) ? clm_double[MINPEAK_r] : (double)(clm_int[MINPEAK + 1]))); /* (< _clm_101 MINPEAK) */
  if ((!_clm_100)) goto L_98;
                                                                                /* (progn */
  clm_int[MINP + 0] = 2;
  clm_double[MINP_r+0] = J;                                                     /* (setf MINP J) */
  {int lci; lci = J;
  switch (CLM_ARR_TYPE(clm_int[PEAK_AMPS + 0 + 1]))
    {
    case 36: clm_int[_clm_105 + 0] = 2;
  clm_double[_clm_105_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_105 + 0] = 1;
  clm_int[_clm_105 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci;
      clm_int[_clm_105 + 0] = clm_int[iblock];
      clm_int[_clm_105 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_105_r + 0] = clm_double[rblock];
  }}}

  clm_int[MINPEAK + 0] = clm_int[_clm_105 + 0];
  clm_int[MINPEAK + 0 + 1] = clm_int[_clm_105 + 0 + 1];
  clm_double[MINPEAK_r + 0] = clm_double[_clm_105_r + 0];                       /* (setf MINPEAK _clm_105) */
  goto L_99;
L_98:
L_99:
  _clm_108 = J + 1.0;
  J = _clm_108;                                                                 /* (setf J _clm_108) */
                                                                                /* (go next-loop */
  goto NEXT_LOOP_L_95;
END_LOOP_L_95:
                                                                                /* (block nil */
                                                                                /* (if (> amp minpeak) */
  _clm_114 = (AMP > ((clm_int[MINPEAK] == 2) ? clm_double[MINPEAK_r] : (double)(clm_int[MINPEAK + 1]))); /* (> AMP MINPEAK) */
  if ((!_clm_114)) goto L_112;
                                                                                /* (progn */
  {int lci; lci = clm_int[MINP + 0 + 1];
  switch (CLM_ARR_TYPE(clm_int[PEAK_FREQS + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + lci] = FREQ; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + lci] = FREQ; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = FREQ;
  }}}

  {int lci; lci = clm_int[MINP + 0 + 1];
  switch (CLM_ARR_TYPE(clm_int[PEAK_AMPS + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci] = AMP; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci] = AMP; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = AMP;
  }}}

  goto L_113;
L_112:
L_113:
  goto L_79;
L_78:
                                                                                /* (progn */
  {int lci; lci = PEAKS;
  switch (CLM_ARR_TYPE(clm_int[PEAK_FREQS + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + lci] = FREQ; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + lci] = FREQ; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_FREQS + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = FREQ;
  }}}

  {int lci; lci = PEAKS;
  switch (CLM_ARR_TYPE(clm_int[PEAK_AMPS + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci] = AMP; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci] = AMP; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[PEAK_AMPS + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = AMP;
  }}}

  {int lci; lci = PEAKS;
  switch (CLM_ARR_TYPE(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + lci] = FREQ; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + lci] = FREQ; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = FREQ;
  }}}

  {int lci; lci = PEAKS;
  switch (CLM_ARR_TYPE(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS_ + 0 + 1]))
    {
    case 36: clm_double[CLM_ARR_RBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS_ + 0 + 1]) + lci] = AMP; break;
    case 37: clm_int[CLM_ARR_IBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS_ + 0 + 1]) + lci] = AMP; break;
    default: {
      int iblock,rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS_ + 0 + 1]) + (lci*2); rblock = CLM_ARR_RBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_AMPS_ + 0 + 1]) + lci;
      clm_int[iblock] = 2; clm_double[rblock] = AMP;
  }}}

                                                                                /* (if printing */
  if (((clm_int[PRINTING] == 0) && (clm_int[PRINTING + 1] == 0))) goto L_125;
  {int lci; lci = PEAKS;
  switch (CLM_ARR_TYPE(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]))
    {
    case 36: clm_int[_clm_128 + 0] = 2;
  clm_double[_clm_128_r+0] = clm_double[CLM_ARR_RBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + lci]; break;
    case 37: clm_int[_clm_128 + 0] = 1;
  clm_int[_clm_128 + 0 + 1] = clm_int[CLM_ARR_IBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + lci]; break;
    default: {
      int iblock, rblock;
      iblock = CLM_ARR_IBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + (lci * 2); rblock = CLM_ARR_RBLOCK(clm_int[_SLIPPERY_CHICKEN_GET_SPECTRUM_PEAK_FREQS_ + 0 + 1]) + lci;
      clm_int[_clm_128 + 0] = clm_int[iblock];
      clm_int[_clm_128 + 0 + 1] = clm_int[iblock+1];
      clm_double[_clm_128_r + 0] = clm_double[rblock];
  }}}

                                                                                /* (clm-print "freq = ~f amp = ~f~&"  _clm_128 AMP) */
  mus_error(0, "freq = %f amp = %f\n",
        (double)((clm_int[_clm_128] == 2) ? clm_double[_clm_128_r] : (double)(clm_int[_clm_128 + 1])),
        (double)AMP);
  goto L_126;
L_125:
L_126:
  PEAKS += 1;                                                                   /* (incf PEAKS 1) */
L_79:
  goto L_51;
L_50:
L_51:
  K += 1;                                                                       /* (incf K 1) */
  goto L_39;
L_41:
goto RUN_ALL_DONE;

RUN_ALL_DONE:
  clm_signal(SIGINT,old_SIGINT);
  clm_int[59] = FFTSIZE;
  if (mus_is_readin(RD))
    {
     clm_int[clm_int[5 + 1] + 3] = mus_increment(RD);
     clm_int[clm_int[5 + 1] + 2] = mus_channel(RD);
    }
  clm_int[61] = HIGHEST_BIN;
  clm_int[63] = MAX_PEAKS;
  clm_int[65] = PEAKS;
  clm_double[27] = J;
  clm_int[67] = LOOP_LIMIT_84;
  if (all_gens) clm_free_genbag(all_gens);

  return(1);
}

